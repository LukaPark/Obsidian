
- **미들웨어** : 라우트 핸들러가 클라이언트 요청을 처리하기 전에 수행되는 컴포넌트.

![[Pasted image 20231124105555.png]]

- **NestJs Middleware** 
	- 기본적으로 Express의 미들 웨어와 동일.
	- 어떤 형태의 코드라도 수행할 수 있음.
	- 요청과 응답에 변형을 가할 수 있음.
	- 요청/응답 주기를 끝낼 수 있음.
		- 응답을 직접 보내거나 에러 처리를 구현 -> 현재 미들웨어가 응답 주기를 끝내고 싶지 않다면 next() 함수를 호출해야 함, 그렇지 않으면 애플리케이션은 아무것도 할 수 없는 상태(*hanging*)
	- 여러 개의 미들웨어를 사용한다면 next()로 호출 스택상 다음 미들웨어에 제어권을 전달.

- **미들웨어의 작업**
	- **쿠키 파싱** : 쿠키를 파싱하여 사용하기 쉬운 데이터 구조로 변경. 이를 이용해 라우터 핸들러에서 쿠키를 파싱할 필요 없앰.
	- **세션 관리** : 세션 쿠키를 찾고, 해당 쿠키에 대한 세션의 상태를 조회 -> 요청에 세션 정보를 추가, 이를 통해 다른 핸들러가 세션 객체를 이용 할 수 있음.
	- **인증/인가** : 사용자가 서비스에 접근 권한이 있는지 확인 -> **Nest**는 인가를 구현 할 때 **가드**를 이용하도록 권장.
	- **본문 파싱** : 본문은 POST/PUT으로 들어오는 JSON 타입 뿐 아니라, 파일 스트림과 같은 데이터도 포함 -> 이 데이터를 유형에 따라 읽고 해석한 다음 매개변수에 넣는 작업을 진행 -> 컨트롤러에서 다루는 본문에는 이렇게 분석된 결과가 포함
	- 기타 : **데이터 베이스 트랜잭션**을 구현할 때 커밋하는 미들웨어 등 커스텀 미들웨어 활용 가능.